version: "3.9"

services:
  # ── PostgreSQL ──
  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ── Redis ──
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD} --maxmemory 256mb --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: [ "CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ── LocalStack (AWS Emulator — S3, Secrets Manager) ──
  localstack:
    image: localstack/localstack:latest
    restart: unless-stopped
    ports:
      - "4566:4566" # LocalStack gateway
      - "4510-4559:4510-4559" # External service ports
    environment:
      - SERVICES=s3,secretsmanager
      - DEBUG=0
      - AWS_DEFAULT_REGION=${AWS_REGION:-us-east-1}
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
    volumes:
      - localstack_data:/var/lib/localstack
      - ./localstack/init-aws.sh:/etc/localstack/init/ready.d/init-aws.sh
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:4566/_localstack/health" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ── API Service (FastAPI) ──
  api_service:
    build:
      context: ./api_service
      dockerfile: Dockerfile
    restart: unless-stopped
    env_file: .env
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      localstack:
        condition: service_healthy
    volumes:
      - model_artifacts:/app/shared/models
    expose:
      - "8000"
    healthcheck:
      test: [ "CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')" ]
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ── Recommendation Engine ──
  recommendation_engine:
    build:
      context: ./recommendation_engine
      dockerfile: Dockerfile
    restart: unless-stopped
    env_file: .env
    depends_on:
      redis:
        condition: service_healthy
      localstack:
        condition: service_healthy
    volumes:
      - model_artifacts:/app/shared/models
    expose:
      - "8001"
    healthcheck:
      test: [ "CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8001/health')" ]
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 20s

  # ── Training Worker (Celery) ──
  training_worker:
    build:
      context: ./training_pipeline
      dockerfile: Dockerfile
    restart: unless-stopped
    env_file: .env
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      localstack:
        condition: service_healthy
    volumes:
      - model_artifacts:/app/shared/models

  # ── NGINX Reverse Proxy ──
  nginx:
    build:
      context: .
      dockerfile: nginx/Dockerfile
    restart: unless-stopped
    ports:
      - "80:80"
    depends_on:
      api_service:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/nginx-health" ]
      interval: 15s
      timeout: 5s
      retries: 3

volumes:
  postgres_data:
  redis_data:
  localstack_data:
  model_artifacts:
